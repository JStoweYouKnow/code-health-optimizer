# .gitlab/agents/code-optimizer/workflows/analyze.yaml
name: "Code Health Analysis"
description: "Scans repository for efficiency issues"

steps:
  - id: clone_repo
    name: "Clone Repository"
    action: git.clone
    inputs:
      depth: 1  # Shallow clone for speed
    outputs:
      repo_path: "${WORKSPACE}/repo"

  - id: detect_languages
    name: "Detect Project Languages"
    action: code.detect_languages
    inputs:
      path: "${clone_repo.repo_path}"
    outputs:
      languages: "${languages}"

  - id: run_analyzers
    name: "Run Code Analyzers"
    action: parallel
    steps:
      - id: dead_code
        action: custom.analyze_dead_code
        inputs:
          repo_path: "${clone_repo.repo_path}"
          languages: "${detect_languages.languages}"

      - id: duplicates
        action: custom.analyze_duplicates
        inputs:
          repo_path: "${clone_repo.repo_path}"
          languages: "${detect_languages.languages}"

      - id: dependencies
        action: custom.analyze_dependencies
        inputs:
          repo_path: "${clone_repo.repo_path}"
          package_files: ["package.json", "requirements.txt", "go.mod"]

  - id: claude_analysis
    name: "Semantic Analysis with Claude"
    action: anthropic.analyze
    inputs:
      prompt: |
        Analyze this codebase for efficiency issues.

        Dead code findings: ${run_analyzers.dead_code.results}
        Duplicate code findings: ${run_analyzers.duplicates.results}
        Dependency issues: ${run_analyzers.dependencies.results}

        For each issue:
        1. Assess confidence (0-100%)
        2. Estimate impact (low/medium/high)
        3. Provide safe removal recommendation
        4. Note any potential side effects

        Output in JSON format.
      system: "You are a senior code reviewer focused on code health and maintainability."
    outputs:
      analysis: "${response.content}"

  - id: calculate_metrics
    name: "Calculate Health Metrics"
    action: custom.calculate_health_score
    inputs:
      findings: "${claude_analysis.analysis}"
    outputs:
      health_score: "${score}"
      total_issues: "${count}"
      estimated_savings: "${hours_saved}"

  - id: create_issues
    name: "Create GitLab Issues"
    action: gitlab.create_issues
    inputs:
      findings: "${claude_analysis.analysis}"
      template: |
        ## Code Health Issue

        **Type:** ${issue.type}
        **Severity:** ${issue.severity}
        **Confidence:** ${issue.confidence}%

        ### Location
        `${issue.file_path}:${issue.line_start}-${issue.line_end}`

        ### Description
        ${issue.description}

        ### Recommendation
        ${issue.recommendation}

        ### Estimated Impact
        - Build time improvement: ${issue.build_time_saved}
        - Bundle size reduction: ${issue.size_reduction}

        ### Code Preview
        ```${issue.language}
        ${issue.code_snippet}
        ```

        ---
        Generated by Code Health Optimizer
      labels:
        - "code-health"
        - "technical-debt"
        - "automated"

  - id: generate_dashboard
    name: "Update Health Dashboard"
    action: gitlab.update_wiki
    inputs:
      page: "Code-Health-Dashboard"
      content: |
        # Code Health Dashboard

        **Last Scan:** ${TIMESTAMP}
        **Health Score:** ${calculate_metrics.health_score}/100

        ## Summary
        - Total Issues Found: ${calculate_metrics.total_issues}
        - Estimated Developer Time Savings: ${calculate_metrics.estimated_savings} hours

        ## Breakdown by Category
        - Dead Code: ${run_analyzers.dead_code.count}
        - Duplicate Logic: ${run_analyzers.duplicates.count}
        - Unused Dependencies: ${run_analyzers.dependencies.count}
